<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3.3.2 Optimising The Server - Frontend Mastery</title>
    <link rel="stylesheet" href="../../../assets/css/styles.css">
</head>
<body>
    <div class="container">
        <aside id="sidebar" class="sidebar"></aside>
        <main class="main-content">
            <section id="section-optimising-the-server">
                <h1>‚ö° Server Optimization: The Second Step</h1>
                <p><strong>HTTP Caching, Compression, CDN and DNS Preconnect ‚Äî How to Reduce Latency and Bytes</strong></p>

                <div class="warning-block" data-title="‚ö†Ô∏è The Truth">
                    <p>If the server takes 2 seconds, nothing else matters.</p>
                    <p>TTFB (Time to First Byte) is the #1 bottleneck in most apps.</p>
                    <p><strong>This step typically gives 30-50% improvement in LCP.</strong></p>
                </div>

                <h2>1Ô∏è‚É£ Mental Model: What Happens When a User Enters?</h2>

                <div class="analogy-block" data-title="üß† The Complete Chain">
                    <ol>
                        <li><strong>DNS lookup</strong> ‚Äî What's the server IP?</li>
                        <li><strong>TCP + TLS handshake</strong> ‚Äî Establish secure connection (if HTTPS)</li>
                        <li><strong>Request sent</strong> ‚Äî Browser asks for HTML</li>
                        <li><strong>Server generates response</strong> ‚Äî Backend processes</li>
                        <li><strong>Download bytes</strong> ‚Äî Network transfer</li>
                        <li><strong>Browser parses and executes</strong> ‚Äî Finally something appears</li>
                    </ol>
                </div>

                <h3>Where Do We Optimize?</h3>

                <div class="concept-block">
                    <ul>
                        <li>‚ùå Eliminate unnecessary requests ‚Üí <strong>Caching</strong></li>
                        <li>üìâ Reduce bytes transferred ‚Üí <strong>Compression</strong></li>
                        <li>üåç Bring content closer to user ‚Üí <strong>CDN</strong></li>
                        <li>‚ö° Prepare connections ahead ‚Üí <strong>DNS Preconnect</strong></li>
                    </ul>
                </div>

                <h2>2Ô∏è‚É£ HTTP Compression: Reduce Size</h2>

                <div class="concept-block">
                    <p><strong>What is it?</strong></p>
                    <p>Compress files (JS, CSS, HTML) before sending to browser.</p>
                    <p>Browser automatically decompresses them.</p>
                </div>

                <h3>How Many Bytes Do You Save?</h3>

                <div class="analogy-block" data-title="Real Example">
                    <ul>
                        <li>JS Bundle: 3MB uncompressed</li>
                        <li>JS Bundle: 1MB compressed</li>
                        <li><strong>Result: 3x faster download</strong></li>
                    </ul>
                </div>

                <h3>Types of Compression</h3>

                <div class="solution-block" data-title="üß© Gzip vs Brotli">
                    <ul>
                        <li><strong>Gzip:</strong> Standard, more compatible, faster</li>
                        <li><strong>Brotli (br):</strong> Modern, better compression, slower (but on server)</li>
                    </ul>
                </div>

                <h3>How to Verify in DevTools</h3>

                <div class="solution-block" data-title="üíª Steps">
                    <ol>
                        <li>Open DevTools ‚Üí Network tab</li>
                        <li>Click a .js file</li>
                        <li>Go to Headers</li>
                        <li>Look for <strong>content-encoding</strong></li>
                    </ol>
                </div>

                <div class="interview-block">
                    <div class="interview-title">
                        <span>üîç What You Should See</span>
                        <span class="toggle-arrow">‚ñ∂</span>
                    </div>
                    <div class="interview-content">
                        <h4>‚úÖ Correct</h4>
                        <pre><code>content-encoding: gzip
content-encoding: br
vary: Accept-Encoding</code></pre>

                        <h4>‚ùå Wrong</h4>
                        <pre><code>(no content-encoding exists)</code></pre>

                        <p><strong>Senior Detail:</strong> Must also have <code>Vary: Accept-Encoding</code> so proxies and CDNs don't mix versions.</p>
                    </div>
                </div>

                <h3>What to Compress vs Not</h3>

                <div class="concept-block">
                    <h4>‚úÖ Always Compress</h4>
                    <ul>
                        <li>JavaScript</li>
                        <li>CSS</li>
                        <li>HTML</li>
                        <li>JSON</li>
                        <li>SVG</li>
                    </ul>
                </div>

                <div class="problem-block" data-title="‚ùå Don't Compress">
                    <ul>
                        <li>JPEG/PNG (already compressed)</li>
                        <li>WebP/AVIF (already compressed)</li>
                        <li>Videos (already compressed)</li>
                    </ul>
                </div>

                <h2>3Ô∏è‚É£ HTTP Caching: Eliminate Requests</h2>

                <div class="warning-block" data-title="‚ö†Ô∏è The Best Optimization">
                    <p>Not downloading is faster than downloading compressed.</p>
                    <p>Cache is where you really win.</p>
                </div>

                <h3>Type A: Strong Cache (Long-term Cache)</h3>

                <div class="solution-block" data-title="üíª Header">
                    <pre><code>Cache-Control: public, max-age=31536000, immutable</code></pre>
                </div>

                <div class="concept-block">
                    <h4>What does it mean?</h4>
                    <ul>
                        <li><strong>public:</strong> Public, can cache in proxy/CDN</li>
                        <li><strong>max-age=31536000:</strong> Store for 1 year</li>
                        <li><strong>immutable:</strong> Never changes, don't validate</li>
                    </ul>
                </div>

                <div class="warning-block" data-title="‚ö†Ô∏è But Wait">
                    <p>What if I deploy new code?</p>
                    <p>Browser still uses old file for 1 year.</p>
                    <p><strong>Solution: Fingerprinting (hash in filename)</strong></p>
                </div>

                <h3>Fingerprinting: The Correct Pattern</h3>

                <div class="solution-block" data-title="‚úÖ Correct Example">
                    <pre><code>app.a34f9c.js      // Hash of content
app.b95d2e.js      // Code changed ‚Üí new hash</code></pre>
                </div>

                <div class="analogy-block" data-title="üß† How It Works">
                    <ol>
                        <li>Original file: app.js</li>
                        <li>Build generates: app.a34f9c.js (hash)</li>
                        <li>HTML points to: app.a34f9c.js</li>
                        <li>User caches: app.a34f9c.js for 1 year</li>
                        <li>Code changes ‚Üí new build</li>
                        <li>Build generates: app.b95d2e.js (different hash)</li>
                        <li>HTML points to: app.b95d2e.js</li>
                        <li>User downloads: app.b95d2e.js (new)</li>
                        <li>User still has: app.a34f9c.js cached (old, unused)</li>
                    </ol>
                </div>

                <h3>Type B: Revalidation Cache</h3>

                <div class="solution-block" data-title="üíª Header for HTML">
                    <pre><code>Cache-Control: no-cache
ETag: "abc123"</code></pre>
                </div>

                <div class="concept-block">
                    <h4>How It Works</h4>
                    <ol>
                        <li>Browser loads: index.html</li>
                        <li>Server sends: ETag: "abc123"</li>
                        <li>Browser saves the file</li>
                        <li>Next load, browser asks: Is ETag still "abc123"?</li>
                        <li>If yes ‚Üí Server responds: 304 Not Modified (no download)</li>
                        <li>If no ‚Üí Server sends: 200 OK (download new version)</li>
                    </ol>
                </div>

                <h3>Senior Strategy in Production</h3>

                <div class="solution-block" data-title="üéØ The Winning Pattern">
                    <pre><code>// HTML (index.html)
Cache-Control: no-cache
ETag: "xyz789"

// JS/CSS with hash
Cache-Control: public, max-age=31536000, immutable

// Images
Cache-Control: public, max-age=31536000

// API responses
Cache-Control: public, max-age=3600 (1 hour)</code></pre>
                </div>

                <h3>Verify in DevTools</h3>

                <div class="interview-block">
                    <div class="interview-title">
                        <span>üîç What to See in Network</span>
                        <span class="toggle-arrow">‚ñ∂</span>
                    </div>
                    <div class="interview-content">
                        <h4>First Load</h4>
                        <pre><code>Status: 200 OK
Size: 45 KB</code></pre>

                        <h4>Second Load (Same browser)</h4>
                        <pre><code>Status: 304 Not Modified
Size: 0 B

Or you'll see: (memory cache) or (disk cache)</code></pre>

                        <h4>Third Load (Different machine, no cache)</h4>
                        <pre><code>Status: 200 OK
Size: 45 KB

(No local cache)</code></pre>
                    </div>
                </div>

                <h2>4Ô∏è‚É£ CDN: Reduce Physical Latency</h2>

                <div class="problem-block" data-title="‚ùå The Problem">
                    <p>Your server is in Germany.</p>
                    <p>User is in Los Angeles.</p>
                    <p>Distance matters. Max speed is speed of light.</p>
                    <p><strong>Example:</strong> 200ms extra just from latency.</p>
                </div>

                <h3>What is a CDN?</h3>

                <div class="concept-block">
                    <p>A CDN (Content Delivery Network) replicates your assets on multiple global servers:</p>
                    <ul>
                        <li>üá™üá∫ Europe</li>
                        <li>üá∫üá∏ USA</li>
                        <li>üá¶üá∫ Asia</li>
                        <li>etc</li>
                    </ul>
                </div>

                <h3>Popular CDNs</h3>

                <div class="solution-block" data-title="üåç Real Options">
                    <ul>
                        <li><strong>Cloudflare:</strong> Free basic plan, very popular</li>
                        <li><strong>AWS CloudFront:</strong> Enterprise, expensive but powerful</li>
                        <li><strong>Netlify:</strong> Automatic if you host there</li>
                        <li><strong>Vercel:</strong> Automatic for Next.js</li>
                    </ul>
                </div>

                <h3>How to Detect if You Use a CDN</h3>

                <div class="solution-block" data-title="üíª Headers in DevTools">
                    <h4>Cloudflare</h4>
                    <pre><code>cf-cache-status: HIT
server: cloudflare</code></pre>

                    <h4>AWS CloudFront</h4>
                    <pre><code>x-cache: Hit from cloudfront
x-amz-cf-pop: LAX50-C1</code></pre>
                </div>

                <div class="interview-block">
                    <div class="interview-title">
                        <span>üéØ Senior Benefit</span>
                        <span class="toggle-arrow">‚ñ∂</span>
                    </div>
                    <div class="interview-content">
                        <p>CDNs usually:</p>
                        <ul>
                            <li>‚úÖ Apply compression automatically</li>
                            <li>‚úÖ Cache automatically</li>
                            <li>‚úÖ Serve from location closest to user</li>
                            <li>‚úÖ Can minify automatically</li>
                            <li>‚úÖ Can optimize images</li>
                        </ul>
                    </div>
                </div>

                <h2>5Ô∏è‚É£ DNS Preconnect: Prepare Connections Ahead</h2>

                <div class="concept-block">
                    <p><strong>Problem:</strong> When you need external resource (fonts, APIs, analytics), it first does:</p>
                    <ul>
                        <li>1Ô∏è‚É£ DNS lookup</li>
                        <li>2Ô∏è‚É£ TCP handshake</li>
                        <li>3Ô∏è‚É£ TLS negotiation</li>
                        <li>4Ô∏è‚É£ Request</li>
                    </ul>
                    <p>Each step takes 50-100ms.</p>
                </div>

                <h3>Solution: Preconnect</h3>

                <div class="solution-block" data-title="üíª In the Head">
                    <pre><code>&lt;head&gt;
  &lt;link rel="preconnect" href="https://fonts.gstatic.com" crossorigin&gt;
  &lt;link rel="preconnect" href="https://api.example.com"&gt;
  &lt;link rel="preconnect" href="https://cdn.analytics.com"&gt;
&lt;/head&gt;</code></pre>
                </div>

                <div class="analogy-block" data-title="üß† What Happens">
                    <p><strong>Without preconnect:</strong> DNS ‚Üí TCP ‚Üí TLS ‚Üí Request ‚Üí Response</p>
                    <p><strong>With preconnect:</strong> DNS + TCP + TLS (in parallel) ‚Üí Request (when needed)</p>
                </div>

                <h3>‚ö†Ô∏è Important</h3>

                <div class="warning-block" data-title="Don't Overuse Preconnect">
                    <p><strong>Use for:</strong> Max 3-4 critical domains</p>
                    <p><strong>DON'T use for:</strong> All CDNs, analytics, ads</p>
                    <p>Preconnect consumes resources.</p>
                </div>

                <h2>6Ô∏è‚É£ How to Audit Your App (Step by Step)</h2>

                <div class="solution-block" data-title="üîç Real Audit in DevTools">
                    <ol>
                        <li><strong>Open DevTools ‚Üí Network</strong></li>
                        <li><strong>Enable "Preserve log"</strong> (checkbox)</li>
                        <li><strong>Hard reload:</strong> Right click ‚Üí Empty cache and hard reload</li>
                        <li><strong>Inspect largest JS</strong>
                            <ul>
                                <li>Does it have content-encoding?</li>
                                <li>Does it have cache-control?</li>
                                <li>Does it have hash in name?</li>
                                <li>What size is it?</li>
                            </ul>
                        </li>
                        <li><strong>Normal reload (Ctrl+R)</strong>
                            <ul>
                                <li>Do you see 304?</li>
                                <li>Do you see (memory cache)?</li>
                                <li>How long did it take?</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <h2>7Ô∏è‚É£ Checklist: What Your App Should Have</h2>

                <div class="concept-block">
                    <table class="cheat-sheet-table">
                        <thead>
                            <tr>
                                <th>Resource</th>
                                <th>Compression</th>
                                <th>Cache</th>
                                <th>CDN</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>HTML</td>
                                <td>‚úÖ gzip/br</td>
                                <td>no-cache + ETag</td>
                                <td>‚úÖ Yes</td>
                            </tr>
                            <tr>
                                <td>JS (with hash)</td>
                                <td>‚úÖ gzip/br</td>
                                <td>max-age: 1 year</td>
                                <td>‚úÖ Yes</td>
                            </tr>
                            <tr>
                                <td>CSS (with hash)</td>
                                <td>‚úÖ gzip/br</td>
                                <td>max-age: 1 year</td>
                                <td>‚úÖ Yes</td>
                            </tr>
                            <tr>
                                <td>Images</td>
                                <td>Native</td>
                                <td>max-age: 30 days</td>
                                <td>‚úÖ Yes</td>
                            </tr>
                            <tr>
                                <td>API Responses</td>
                                <td>‚úÖ gzip/br</td>
                                <td>max-age: 1 hour</td>
                                <td>‚ùå No</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h2>8Ô∏è‚É£ Common Mistakes (Avoid These)</h2>

                <div class="problem-block" data-title="‚ùå Mistake #1: Cache HTML aggressively">
                    <p>If you cache index.html for 1 year, users get trapped in old version.</p>
                    <p><strong>Solution:</strong> Use no-cache + ETag.</p>
                </div>

                <div class="problem-block" data-title="‚ùå Mistake #2: No fingerprint in filenames">
                    <p>If code changes but filename doesn't, users still have old version.</p>
                    <p><strong>Solution:</strong> Hash in filename (app.a34f9c.js).</p>
                </div>

                <div class="problem-block" data-title="‚ùå Mistake #3: Don't verify real headers">
                    <p>You think everything is compressed but DevTools shows otherwise.</p>
                    <p><strong>Solution:</strong> Audit in DevTools or run curl.</p>
                </div>

                <div class="problem-block" data-title="‚ùå Mistake #4: Preconnect to everything">
                    <p>Preconnect to 20 domains and slow down the page.</p>
                    <p><strong>Solution:</strong> Only 3-4 critical domains.</p>
                </div>

                <h2>9Ô∏è‚É£ Senior Interview Answer</h2>

                <div class="interview-block">
                    <div class="interview-title">
                        <span>üé§ "How would you optimize the server?"</span>
                        <span class="toggle-arrow">‚ñ∂</span>
                    </div>
                    <div class="interview-content">
                        <p><strong>Senior Response:</strong></p>
                        <blockquote>
                            <p>"First I'd apply compression (Brotli or gzip) verifying headers have content-encoding and vary: accept-encoding.</p>
                            <p>Implement strong caching for hashed assets using Cache-Control: public, max-age=31536000, immutable for JS/CSS.</p>
                            <p>For HTML I'd use no-cache with ETag for revalidation, preventing users from getting trapped in old versions.</p>
                            <p>Deploy a CDN to reduce geographic latency.</p>
                            <p>For critical external resources, add preconnect limited to 3-4 domains.</p>
                            <p>Audit everything in DevTools Network tab checking real headers.</p>
                            <p>The goal is reducing TTFB and ensuring deploys automatically invalidate cache."</p>
                        </blockquote>
                    </div>
                </div>

                <h2>üîü Connection to Core Web Vitals</h2>

                <div class="solution-block" data-title="üìä Real Impact">
                    <ul>
                        <li><strong>Caching:</strong> Improves TTFB, FCP, LCP (50% in ideal case)</li>
                        <li><strong>Compression:</strong> Improves LCP (30-40%)</li>
                        <li><strong>CDN:</strong> Improves TTFB (20-30%)</li>
                        <li><strong>Preconnect:</strong> Improves LCP for critical resources (10-15%)</li>
                    </ul>
                </div>

                <h2>1Ô∏è‚É£1Ô∏è‚É£ Actionable Checklist Now</h2>

                <div class="solution-block" data-title="‚úÖ Do This Today">
                    <ol>
                        <li>Open your app in Chrome</li>
                        <li>DevTools ‚Üí Network ‚Üí Hard reload</li>
                        <li>Click a large .js file</li>
                        <li>Look at Headers ‚Üí Does it have content-encoding?</li>
                        <li>Look at Headers ‚Üí Does it have cache-control?</li>
                        <li>If no compression, enable on server</li>
                        <li>If not caching well, adjust headers</li>
                        <li>If you're in USA but server in Germany, CDN is urgent</li>
                        <li>Normal reload and check if you see 304</li>
                    </ol>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-primary" onclick="window.location.href='17-diagnosis.html'">‚Üê Back to Diagnosis</button>
                    <button class="btn btn-primary" onclick="window.location.href='../../../index.html'">Back to Start ‚Üí</button>
                </div>
            </section>
        </main>
    </div>

    <script src="../../../assets/js/app.js"></script>
</body>
</html>
