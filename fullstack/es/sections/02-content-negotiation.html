<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTTP Content Negotiation & Compression | FullStack</title>
    <link rel="stylesheet" href="../../../assets/css/styles.css">
</head>
<body>
    <div class="container">
        <main class="main-content">
            <section id="section-content-negotiation">
                <h1>1.1.1 HTTP Content Negotiation & Compression</h1>
                <p><strong>Entiende lo que hacen Express y los frameworks por debajo</strong></p>

                <h2>1Ô∏è‚É£ El Problema que estamos resolviendo</h2>

                <p>Cuando un cliente hace una petici√≥n HTTP:</p>
                <pre><code>GET /hello</code></pre>

                <p>No solo pide "dame algo". Tambi√©n dice:</p>
                <ul>
                    <li>üì¶ En qu√© formato lo quiere (Accept)</li>
                    <li>üìâ Si soporta compresi√≥n (Accept-Encoding)</li>
                </ul>

                <p>El servidor entonces decide:</p>
                <ul>
                    <li>üßæ Qu√© formato devolver (Content-Type)</li>
                    <li>üóúÔ∏è Si lo env√≠a comprimido (Content-Encoding)</li>
                </ul>

                <p><strong>Esto es Content Negotiation.</strong></p>

                <h2>2Ô∏è‚É£ Mental Model (Muy importante)</h2>

                <p>Imagina un restaurante:</p>

                <p><strong>üë§ Cliente:</strong></p>
                <p>"Quiero el men√∫ en espa√±ol y en versi√≥n resumida."</p>

                <p><strong>üë®‚Äçüç≥ Servidor:</strong></p>
                <p>"Vale, aqu√≠ tienes el men√∫ en espa√±ol (Content-Type) y comprimido porque pesa mucho (Content-Encoding)."</p>

                <p><strong>Eso es exactamente lo que hace HTTP.</strong></p>

                <h2>3Ô∏è‚É£ Headers Clave (La Base Real)</h2>

                <p><strong>üìå Negotiation de formato</strong></p>

                <p>Cliente env√≠a:</p>
                <pre><code>Accept: application/json</code></pre>

                <p>Servidor responde:</p>
                <pre><code>Content-Type: application/json</code></pre>

                <p><strong>üìå Negotiation de compresi√≥n</strong></p>

                <p>Cliente env√≠a:</p>
                <pre><code>Accept-Encoding: gzip, br</code></pre>

                <p>Servidor responde:</p>
                <pre><code>Content-Encoding: gzip</code></pre>

                <p><strong>üìå Header CR√çTICO en producci√≥n</strong></p>
                <pre><code>Vary: Accept, Accept-Encoding</code></pre>

                <p>üî¥ Esto le dice a CDNs y caches:</p>
                <p>"La respuesta cambia seg√∫n estos headers."</p>

                <p><strong>Si no lo pones, puedes romper producci√≥n. Esto es detalle senior.</strong></p>

                <h2>4Ô∏è‚É£ Flujo Real Paso a Paso</h2>

                <ol>
                    <li>Cliente ‚Üí Env√≠a Accept y Accept-Encoding</li>
                    <li>Servidor ‚Üí Decide representaci√≥n</li>
                    <li>Servidor ‚Üí Decide compresi√≥n</li>
                    <li>Servidor ‚Üí Devuelve Content-Type + Content-Encoding</li>
                    <li>Browser ‚Üí Interpreta correctamente</li>
                </ol>

                <h2>5Ô∏è‚É£ Implementaci√≥n Completa en Node (sin Express)</h2>

                <p><strong>Esto es lo que realmente hace un middleware por dentro.</strong></p>

                <pre><code>import http from "node:http";
import zlib from "node:zlib";

const server = http.createServer((req, res) => {

  // ===============================
  // 1Ô∏è‚É£ CONTENT NEGOTIATION
  // ===============================

  const accept = req.headers["accept"] || "*/*";

  let contentType;
  let body;

  if (accept.includes("application/json")) {
    contentType = "application/json; charset=utf-8";
    body = JSON.stringify({ message: "Hello World" });

  } else if (accept.includes("text/html")) {
    contentType = "text/html; charset=utf-8";
    body = "&lt;h1&gt;Hello World&lt;/h1&gt;";

  } else if (accept.includes("text/plain") || accept.includes("*/*")) {
    contentType = "text/plain; charset=utf-8";
    body = "Hello World";

  } else {
    res.writeHead(406, {
      "Content-Type": "text/plain",
      "Vary": "Accept"
    });
    res.end("Not Acceptable");
    return;
  }

  // ===============================
  // 2Ô∏è‚É£ COMPRESSION NEGOTIATION
  // ===============================

  const acceptEncoding = req.headers["accept-encoding"] || "";
  const supportsBrotli = acceptEncoding.includes("br");
  const supportsGzip = acceptEncoding.includes("gzip");

  res.setHeader("Content-Type", contentType);
  res.setHeader("Vary", "Accept, Accept-Encoding");

  const shouldCompress = body.length > 200;

  if (shouldCompress && supportsBrotli) {
    const compressed = zlib.brotliCompressSync(Buffer.from(body));
    res.setHeader("Content-Encoding", "br");
    res.writeHead(200);
    res.end(compressed);
    return;
  }

  if (shouldCompress && supportsGzip) {
    const compressed = zlib.gzipSync(Buffer.from(body));
    res.setHeader("Content-Encoding", "gzip");
    res.writeHead(200);
    res.end(compressed);
    return;
  }

  // Sin compresi√≥n
  res.writeHead(200);
  res.end(body);
});

server.listen(3000, () =>
  console.log("Server running at http://localhost:3000")
);</code></pre>

                <h2>6Ô∏è‚É£ Cosas que un Junior suele hacer mal</h2>

                <ul>
                    <li>‚ùå Comprimir sin comprobar Accept-Encoding</li>
                    <li>‚ùå No poner Content-Type</li>
                    <li>‚ùå No usar Vary</li>
                    <li>‚ùå No devolver 406 cuando no hay match</li>
                    <li>‚ùå No entender diferencia entre Accept y Content-Type</li>
                </ul>

                <h2>7Ô∏è‚É£ Diferencias CR√çTICAS (Pregunta t√≠pica)</h2>

                <table class="cheat-sheet-table">
                    <thead>
                        <tr>
                            <th>Header</th>
                            <th>Qui√©n lo env√≠a</th>
                            <th>Qu√© significa</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Accept</td>
                            <td>Cliente</td>
                            <td>Qu√© quiero recibir</td>
                        </tr>
                        <tr>
                            <td>Content-Type</td>
                            <td>Servidor (o cliente en POST)</td>
                            <td>Qu√© estoy enviando</td>
                        </tr>
                        <tr>
                            <td>Accept-Encoding</td>
                            <td>Cliente</td>
                            <td>Qu√© compresi√≥n soporto</td>
                        </tr>
                        <tr>
                            <td>Content-Encoding</td>
                            <td>Servidor</td>
                            <td>C√≥mo lo comprim√≠</td>
                        </tr>
                        <tr>
                            <td>Vary</td>
                            <td>Servidor</td>
                            <td>Qu√© headers afectan la respuesta</td>
                        </tr>
                    </tbody>
                </table>

                <h2>8Ô∏è‚É£ DevTools: C√≥mo verlo en la vida real</h2>

                <ol>
                    <li>Abre cualquier web</li>
                    <li>Ve a Network</li>
                    <li>Selecciona un .js</li>
                    <li>Mira:
                        <pre><code>Content-Type: application/javascript
Content-Encoding: br
Vary: Accept-Encoding</code></pre>
                    </li>
                </ol>

                <p>üî• Ya sabes leerlo.</p>

                <h2>9Ô∏è‚É£ Checklist Profesional (Antes de subir a producci√≥n)</h2>

                <ul>
                    <li>‚úÖ Devuelvo siempre Content-Type correcto</li>
                    <li>‚úÖ Negocio correctamente con Accept</li>
                    <li>‚úÖ Negocio compresi√≥n con Accept-Encoding</li>
                    <li>‚úÖ Pongo Vary</li>
                    <li>‚úÖ No comprimo im√°genes o binarios innecesarios</li>
                    <li>‚úÖ Uso Brotli si est√° disponible</li>
                    <li>‚úÖ Devuelvo 406 si no hay representaci√≥n compatible</li>
                </ul>

                <h2>üîü Preguntas T√≠picas de Entrevista (Con Respuesta Senior)</h2>

                <p><strong>‚ùì ¬øQu√© es Content Negotiation?</strong></p>
                <p>Es el mecanismo mediante el cual el servidor devuelve distintas representaciones del mismo recurso seg√∫n los headers del cliente (Accept, Accept-Encoding, etc.).</p>

                <p><strong>‚ùì Diferencia entre Accept y Content-Type</strong></p>
                <p>Accept ‚Üí Lo que el cliente quiere recibir<br>Content-Type ‚Üí Lo que el servidor realmente devuelve</p>

                <p><strong>‚ùì Qu√© pasa si comprimo pero no pongo Content-Encoding</strong></p>
                <p>El cliente no sabr√° que debe descomprimirlo y fallar√° al interpretarlo.</p>

                <p><strong>‚ùì Para qu√© sirve el header Vary</strong></p>
                <p>Indica a caches/CDNs que la respuesta cambia seg√∫n ciertos headers. Sin Vary puedes romper cacheo.</p>

                <p><strong>‚ùì Qu√© status code devuelves si no puedes producir el formato solicitado</strong></p>
                <p>406 Not Acceptable</p>

                <p><strong>‚ùì Qu√© status code devuelves si el cliente env√≠a un body en formato no soportado</strong></p>
                <p>415 Unsupported Media Type</p>

                <h2>1Ô∏è‚É£1Ô∏è‚É£ Por qu√© esto es importante como Frontend Developer</h2>

                <p>Aunque uses Express, Next.js o un CDN:</p>

                <ul>
                    <li>Te ayuda a debuggear APIs</li>
                    <li>Te ayuda a entender performance</li>
                    <li>Te ayuda en entrevistas senior</li>
                    <li>Te permite optimizar Core Web Vitals</li>
                    <li>Te permite leer DevTools como un profesional</li>
                </ul>

                <h2>üéØ Resumen Final</h2>

                <ul>
                    <li><strong>Content Negotiation</strong> = elegir formato</li>
                    <li><strong>Compression</strong> = reducir tama√±o</li>
                    <li><strong>Vary</strong> = hacerlo compatible con cache</li>
                    <li><strong>Content-Type</strong> = declarar qu√© es</li>
                    <li><strong>Content-Encoding</strong> = declarar c√≥mo est√° comprimido</li>
                </ul>

                <p><strong>Los frameworks solo automatizan esto. Pero ahora t√∫ entiendes el mecanismo real.</strong></p>

                <div class="navigation-buttons">
                    <button class="btn btn-secondary" onclick="window.location.href='01-fundamentos-web.html'">‚Üê Anterior</button>
                    <button class="btn btn-primary" onclick="window.location.href='../../../index.html'">Volver al Inicio ‚Üí</button>
                </div>
            </section>
        </main>
    </div>

    <script src="../../../assets/js/app.js"></script>
</body>
</html>