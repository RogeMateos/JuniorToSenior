<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CÃ³mo Funciona Realmente una API Backend Moderna | FullStack</title>
    <link rel="stylesheet" href="../../../assets/css/styles.css">
</head>
<body>
    <div class="container">
        <main class="main-content">
            <section id="section-how-apis-work">
                <h1>1.3.1 Fundamentals: How Modern APIs Really Work</h1>
                <p><strong>Una API moderna no es mÃ¡gica. Es simplemente una mÃ¡quina que recibe una request, ejecuta lÃ³gica y devuelve una response.</strong></p>

                <h2>0ï¸âƒ£ El Modelo Mental Correcto</h2>

                <p><strong>Una API moderna bÃ¡sicamente hace esto:</strong></p>

                <pre><code>Request â†’ Middleware â†’ Controller â†’ Service â†’ Database â†’ Response</code></pre>

                <p>En palabras simples:</p>
                <ul>
                    <li>El cliente envÃ­a una peticiÃ³n HTTP</li>
                    <li>La peticiÃ³n pasa por varios filtros (middlewares)</li>
                    <li>Llega a un handler (controller)</li>
                    <li>Se ejecuta la lÃ³gica de negocio (service)</li>
                    <li>Se habla con la base de datos</li>
                    <li>Se devuelve una respuesta</li>
                </ul>

                <p><strong>Eso es el 90% de cualquier backend del mundo.</strong></p>

                <h2>1ï¸âƒ£ Â¿QuÃ© es un Middleware? (ExplicaciÃ³n Clara)</h2>

                <p><strong>Un middleware es simplemente una funciÃ³n que se ejecuta ANTES de que tu endpoint procese la peticiÃ³n.</strong></p>

                <p>Es como un filtro o guardia de seguridad.</p>

                <h3>ğŸ¢ AnalogÃ­a Sencilla</h3>

                <p>Imagina un edificio:</p>
                <ul>
                    <li>El cliente = visitante</li>
                    <li>La API = edificio</li>
                    <li>El middleware = seguridad en la puerta</li>
                </ul>

                <p>Antes de entrar:</p>
                <ul>
                    <li>Â¿Tienes identificaciÃ³n? â†’ auth middleware</li>
                    <li>Â¿Traes algo prohibido? â†’ validation middleware</li>
                    <li>Â¿Vienes demasiado seguido? â†’ rate limit middleware</li>
                </ul>

                <p>Si todo estÃ¡ correcto, pasas. Si no, te paran ahÃ­.</p>

                <h3>ğŸ“Œ Middleware en Express</h3>

                <p>En Express un middleware es una funciÃ³n con esta forma:</p>

                <pre><code>(req, res, next) => {
  // hacer algo
  next()
}</code></pre>

                <ul>
                    <li><strong>req</strong> â†’ request</li>
                    <li><strong>res</strong> â†’ response</li>
                    <li><strong>next()</strong> â†’ pasa al siguiente middleware o handler</li>
                </ul>

                <p><strong>Si no llamas next(), la peticiÃ³n se queda bloqueada.</strong></p>

                <h3>ğŸ§© Ejemplo Real: Middleware de JSON Parser</h3>

                <pre><code>app.use(express.json())</code></pre>

                <p>Esto es un middleware global. Convierte el body en JSON automÃ¡ticamente.</p>

                <h3>ğŸ” Ejemplo Real: Middleware de AutenticaciÃ³n</h3>

                <pre><code>function authenticate(req, res, next) {
  const token = req.headers.authorization

  if (!token) {
    return res.status(401).json({ error: "Unauthorized" })
  }

  // validar token...
  next()
}</code></pre>

                <p>Si no hay token â†’ 401. Si hay token â†’ continÃºa.</p>

                <h2>2ï¸âƒ£ Arquitectura Profesional (Capas)</h2>

                <p><strong>En apps pequeÃ±as puedes poner todo en el handler.</strong></p>
                <p><strong>En apps reales NO.</strong></p>

                <p>Estructura tÃ­pica:</p>
                <pre><code>routes/
controllers/
services/
repositories/
middleware/
shared/</code></pre>

                <h3>ğŸ”¹ Routes (Conecta Todo)</h3>

                <p>Define el endpoint.</p>

                <pre><code>router.post("/payments", authenticate, createPaymentController)</code></pre>

                <p>Solo conecta cosas. No tiene lÃ³gica.</p>

                <h3>ğŸ”¹ Controller (Traduce HTTP)</h3>

                <p>Se encarga de HTTP: extrae datos del request, llama al service, responde.</p>

                <pre><code>export async function createPaymentController(req, res, next) {
  try {
    const result = await createPayment(req.body)
    res.status(201).json(result)
  } catch (err) {
    next(err)
  }
}</code></pre>

                <p><strong>No contiene lÃ³gica de negocio compleja.</strong></p>

                <h3>ğŸ”¹ Service (LÃ³gica de Negocio)</h3>

                <p>AquÃ­ viven:</p>
                <ul>
                    <li>Validaciones de negocio</li>
                    <li>Algoritmos</li>
                    <li>CoordinaciÃ³n de DB + APIs externas</li>
                    <li>Transacciones</li>
                </ul>

                <pre><code>export async function createPayment(data) {
  if (data.amount <= 0) {
    throw new Error("Invalid amount")
  }

  const payment = await paymentRepo.insert(data)

  return {
    id: payment.id,
    status: "CREATED"
  }
}</code></pre>

                <h3>ğŸ”¹ Repository (Solo BD)</h3>

                <p>Solo habla con la base de datos. Nada mÃ¡s.</p>

                <pre><code>class PaymentRepo {
  async insert(data) {
    return db.payments.insert(data)
  }

  async findById(id) {
    return db.payments.findOne({ id })
  }
}</code></pre>

                <h2>3ï¸âƒ£ Flujo Completo de un Endpoint (POST /payments)</h2>

                <h3>Paso 1: Cliente envÃ­a request</h3>

                <pre><code>POST /api/payments
Authorization: Bearer token123
Content-Type: application/json

{
  "amount": 50,
  "currency": "USD"
}</code></pre>

                <h3>Paso 2: Middlewares globales</h3>

                <pre><code>1. Request ID (tracking)
2. Logger (start)
3. JSON parser
4. CORS (si aplica)</code></pre>

                <h3>Paso 3: Middlewares especÃ­ficos de ruta</h3>

                <pre><code>1. Auth (Â¿token vÃ¡lido?)
2. Validate (Â¿data vÃ¡lida?)
3. Authorize (Â¿tienes permisos?)</code></pre>

                <h3>Paso 4: Controller recibe datos limpios</h3>

                <pre><code>const { amount, currency } = req.body
const userId = req.user.id</code></pre>

                <h3>Paso 5: Service ejecuta lÃ³gica</h3>

                <pre><code>// ValidaciÃ³n
if (amount <= 0) throw error

// LÃ³gica
const fxRate = await currencyApi.getRate(currency)
const totalInEur = amount * fxRate

// BD
const payment = await repo.insert({
  userId,
  amount,
  currency,
  fxRate
})</code></pre>

                <h3>Paso 6: Response</h3>

                <pre><code>201 Created
{
  "paymentId": "abc123",
  "status": "CREATED",
  "amount": 50,
  "currency": "USD"
}</code></pre>

                <h2>4ï¸âƒ£ Sequence Diagram (Mentalidad Senior)</h2>

                <p><strong>Un senior siempre dibuja el flujo antes de codear.</strong></p>

                <pre><code>Client
  â”‚
  â”œâ”€ POST /payments
  â”‚
  â””â”€â”€â†’ API
       â”‚
       â”œâ”€ JSON Parser âœ…
       â”‚
       â”œâ”€ Auth Middleware
       â”‚  â”œâ”€ âœ… Token vÃ¡lido
       â”‚  â””â”€ âŒ Sin token â†’ 401
       â”‚
       â”œâ”€ Validate Middleware
       â”‚  â”œâ”€ âœ… Data vÃ¡lida
       â”‚  â””â”€ âŒ Data invÃ¡lida â†’ 422
       â”‚
       â”œâ”€ Controller
       â”‚  â”‚
       â”‚  â””â”€â”€â†’ Service
       â”‚       â”‚
       â”‚       â”œâ”€ Check amount > 0
       â”‚       â”‚
       â”‚       â”œâ”€ Get FX rate
       â”‚       â”‚  â”œâ”€ âœ… API OK
       â”‚       â”‚  â””â”€ âŒ API caÃ­da â†’ 503
       â”‚       â”‚
       â”‚       â””â”€ Insert to DB
       â”‚          â”œâ”€ âœ… Inserted
       â”‚          â””â”€ âŒ Error â†’ 500
       â”‚
       â””â”€â”€â†’ Response 201</code></pre>

                <p><strong>Un senior siempre piensa:</strong></p>
                <ul>
                    <li>Â¿QuÃ© pasa si falla la BD?</li>
                    <li>Â¿QuÃ© pasa si falla la API externa?</li>
                    <li>Â¿QuÃ© status code devolvemos?</li>
                    <li>Â¿Hay condiciones de carrera?</li>
                    <li>Â¿Hay transacciones que necesito?</li>
                </ul>

                <h2>5ï¸âƒ£ HTTP Status Codes Correctos (Muy Importante)</h2>

                <table class="cheat-sheet-table">
                    <thead>
                        <tr>
                            <th>CÃ³digo</th>
                            <th>CuÃ¡ndo usarlo</th>
                            <th>Ejemplo</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>200</td>
                            <td>OK general</td>
                            <td>GET /payments (leer datos)</td>
                        </tr>
                        <tr>
                            <td>201</td>
                            <td>Created</td>
                            <td>POST /payments (crear)</td>
                        </tr>
                        <tr>
                            <td>204</td>
                            <td>No Content</td>
                            <td>DELETE /payments/123</td>
                        </tr>
                        <tr>
                            <td>400</td>
                            <td>Bad Request</td>
                            <td>JSON invÃ¡lido, campo faltante</td>
                        </tr>
                        <tr>
                            <td>401</td>
                            <td>Unauthorized</td>
                            <td>Token ausente/invÃ¡lido</td>
                        </tr>
                        <tr>
                            <td>403</td>
                            <td>Forbidden</td>
                            <td>Autenticado pero sin permisos</td>
                        </tr>
                        <tr>
                            <td>404</td>
                            <td>Not Found</td>
                            <td>Recurso no existe</td>
                        </tr>
                        <tr>
                            <td>409</td>
                            <td>Conflict</td>
                            <td>Email duplicado</td>
                        </tr>
                        <tr>
                            <td>422</td>
                            <td>Unprocessable</td>
                            <td>Data vÃ¡lida pero rechazada por negocio</td>
                        </tr>
                        <tr>
                            <td>500</td>
                            <td>Server Error</td>
                            <td>Bug inesperado</td>
                        </tr>
                        <tr>
                            <td>503</td>
                            <td>Service Unavailable</td>
                            <td>BD caÃ­da, API externa no responde</td>
                        </tr>
                    </tbody>
                </table>

                <p><strong>Nunca uses 200 para errores.</strong></p>

                <h2>6ï¸âƒ£ Error Handler Global (Nivel Pro)</h2>

                <p><strong>En lugar de esparcir error handling por todos lados...</strong></p>

                <pre><code>// âŒ Feo: repetir en cada endpoint
app.post("/payments", (req, res) => {
  try {
    // lÃ³gica
    res.json(result)
  } catch (err) {
    res.status(500).json({ error: "Server error" })
  }
})</code></pre>

                <p><strong>Haces un middleware global:</strong></p>

                <pre><code>// âœ… Limpio: un lugar para todos los errores
function errorHandler(err, req, res, next) {
  const status = err.status || 500
  const message = err.message || "Unexpected error"

  logger.error("Error", { status, message, url: req.path })

  res.status(status).json({
    error: {
      code: err.code || "UNKNOWN",
      message: message
    }
  })
}

app.use(errorHandler)</code></pre>

                <p><strong>Ventajas:</strong></p>
                <ul>
                    <li>Un solo lugar para manejar errores</li>
                    <li>Formato consistente</li>
                    <li>Logging centralizado</li>
                    <li>FÃ¡cil de cambiar despuÃ©s</li>
                </ul>

                <h2>7ï¸âƒ£ SeparaciÃ³n de Responsabilidades (Principio SOLID)</h2>

                <p><strong>Cada capa tiene UN trabajo.</strong></p>

                <table class="cheat-sheet-table">
                    <thead>
                        <tr>
                            <th>Capa</th>
                            <th>Responsabilidad</th>
                            <th>NO hace</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Route</td>
                            <td>Conectar middlewares y controller</td>
                            <td>LÃ³gica</td>
                        </tr>
                        <tr>
                            <td>Middleware</td>
                            <td>Filtrar/validar antes de llegar</td>
                            <td>LÃ³gica de negocio</td>
                        </tr>
                        <tr>
                            <td>Controller</td>
                            <td>HTTP: parsear, responder</td>
                            <td>LÃ³gica de negocio</td>
                        </tr>
                        <tr>
                            <td>Service</td>
                            <td>LÃ³gica, reglas, orquestaciÃ³n</td>
                            <td>Hablar con HTTP o BD directamente</td>
                        </tr>
                        <tr>
                            <td>Repository</td>
                            <td>Acceso a datos</td>
                            <td>LÃ³gica de negocio</td>
                        </tr>
                    </tbody>
                </table>

                <p><strong>ViolaciÃ³n de SOLID (BAD):</strong></p>

                <pre><code>// âŒ Controller con TODO
app.post("/payments", async (req, res) => {
  // parsing (OK)
  // validaciÃ³n de negocio (NO AQUÃ)
  // query directo a BD (NO AQUÃ)
  // email a tercero (NO AQUÃ)
  // respuesta (OK)
})</code></pre>

                <p><strong>Respeto SOLID (GOOD):</strong></p>

                <pre><code>// âœ… Cada cosa en su lugar
app.post("/payments", authenticate, async (req, res, next) => {
  try {
    const result = await createPaymentService(req.body)
    res.json(result)
  } catch (err) {
    next(err)
  }
})</code></pre>

                <h2>8ï¸âƒ£ Buenas PrÃ¡cticas Senior</h2>

                <ul>
                    <li>âœ… Separar responsabilidades (Controller â‰  Service â‰  Repo)</li>
                    <li>âœ… Nunca mezclar lÃ³gica de negocio con HTTP</li>
                    <li>âœ… Validar siempre inputs en el middleware</li>
                    <li>âœ… Manejar errores centralizadamente</li>
                    <li>âœ… Pensar en fallos ANTES que en happy path</li>
                    <li>âœ… Usar sequence diagrams para endpoints complejos</li>
                    <li>âœ… Logging con requestId para tracing</li>
                    <li>âœ… Status codes correctos (no 200 para todo)</li>
                    <li>âœ… Transactions para operaciones crÃ­ticas</li>
                    <li>âœ… Rate limiting en endpoints sensibles</li>
                </ul>

                <h2>9ï¸âƒ£ Lo MÃ¡s Importante Que Debes Recordar</h2>

                <p><strong>"Un backend no es mÃ¡s que una mÃ¡quina que recibe una request, ejecuta lÃ³gica y devuelve una response. Todo lo demÃ¡s son capas para hacerlo mantenible, escalable, testeable y profesional."</strong></p>

                <h2>ğŸ”Ÿ PrÃ³ximos Pasos</h2>

                <p>Ahora que entiendes el modelo, puedes:</p>

                <ul>
                    <li>ğŸ‘‰ Ir a secciÃ³n 1.3 "API Business Logic" para ver cÃ³digo real</li>
                    <li>ğŸ‘‰ Ir a secciÃ³n 1.4 "Database Design" para entender persistencia</li>
                    <li>ğŸ§ª Aprender testing con Jest en servicios</li>
                    <li>ğŸ” Profundizar en seguridad (JWT, salting passwords)</li>
                    <li>ğŸš€ Deploy y DevOps (Docker, CI/CD)</li>
                </ul>

                <div class="navigation-buttons">
                    <button class="btn btn-secondary" onclick="window.location.href='04-rest-apis.html'">â† Anterior: REST APIs</button>
                    <button class="btn btn-primary" onclick="window.location.href='05-api-business-logic.html'">Siguiente: API Business Logic â†’</button>
                </div>
            </section>
        </main>
    </div>

    <script src="../../../assets/js/app.js"></script>
</body>
</html>
